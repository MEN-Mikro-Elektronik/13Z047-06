<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - Z47 MDIS Driver - z47_drv.c Source File</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;">
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">Z47 MDIS Driver &nbsp; </h1>
	<h3>z47_drv.c Source File</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>z47_drv.c</h1><a href="z47__drv_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*********************  P r o g r a m  -  M o d u l e ***********************/</span>
00013  <span class="comment">/*</span>
00014 <span class="comment"> *---------------------------------------------------------------------------</span>
00015 <span class="comment"> * Copyright (c) 2016-2019, MEN Mikro Elektronik GmbH</span>
00016 <span class="comment"> ****************************************************************************/</span>
00017 <span class="comment">/*</span>
00018 <span class="comment">* This program is free software: you can redistribute it and/or modify</span>
00019 <span class="comment">* it under the terms of the GNU General Public License as published by</span>
00020 <span class="comment">* the Free Software Foundation, either version 2 of the License, or</span>
00021 <span class="comment">* (at your option) any later version.</span>
00022 <span class="comment">*</span>
00023 <span class="comment">* This program is distributed in the hope that it will be useful,</span>
00024 <span class="comment">* but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00025 <span class="comment">* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00026 <span class="comment">* GNU General Public License for more details.</span>
00027 <span class="comment">*</span>
00028 <span class="comment">* You should have received a copy of the GNU General Public License</span>
00029 <span class="comment">* along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
00030 <span class="comment">*/</span>
00031 
<a name="l00032"></a><a class="code" href="z47__drv_8c.html#a0">00032</a> <span class="preprocessor">#define _NO_LL_HANDLE        </span><span class="comment">/* ll_defs.h: don't define LL_HANDLE struct */</span>
00033 
00034 <span class="comment">/*-----------------------------------------+</span>
00035 <span class="comment">|  INCLUDES                                |</span>
00036 <span class="comment">+-----------------------------------------*/</span>
00037 <span class="preprocessor">#include &lt;MEN/men_typs.h&gt;</span>    <span class="comment">/* system dependent definitions   */</span>
00038 <span class="preprocessor">#include &lt;MEN/maccess.h&gt;</span>     <span class="comment">/* hw access macros and types     */</span>
00039 <span class="preprocessor">#include &lt;MEN/dbg.h&gt;</span>         <span class="comment">/* debug functions                */</span>
00040 <span class="preprocessor">#include &lt;MEN/oss.h&gt;</span>         <span class="comment">/* oss functions                  */</span>
00041 <span class="preprocessor">#include &lt;MEN/desc.h&gt;</span>        <span class="comment">/* descriptor functions           */</span>
00042 <span class="preprocessor">#include &lt;MEN/mdis_api.h&gt;</span>    <span class="comment">/* MDIS global defs               */</span>
00043 <span class="preprocessor">#include &lt;MEN/mdis_com.h&gt;</span>    <span class="comment">/* MDIS common defs               */</span>
00044 <span class="preprocessor">#include &lt;MEN/mdis_err.h&gt;</span>    <span class="comment">/* MDIS error codes               */</span>
00045 <span class="preprocessor">#include &lt;MEN/ll_defs.h&gt;</span>     <span class="comment">/* low-level driver definitions   */</span>
00046 <span class="preprocessor">#include &lt;<a class="code" href="wdog_8h.html">MEN/wdog.h</a>&gt;</span>        <span class="comment">/* watchdog status codes          */</span>
00047 <span class="preprocessor">#include &lt;MEN/z47.h&gt;</span>         <span class="comment">/* 16Z047 IP core reg definitions */</span>
00048 <span class="preprocessor">#include &lt;MEN/chameleon.h&gt;</span>   <span class="comment">/* chameleon header               */</span>
00049 
00050 <span class="comment">/*-----------------------------------------+</span>
00051 <span class="comment">|  DEFINES                                 |</span>
00052 <span class="comment">+-----------------------------------------*/</span>
00053 
00054 <span class="comment">/* general defines */</span>
<a name="l00055"></a><a class="code" href="z47__drv_8c.html#a1">00055</a> <span class="preprocessor">#define CH_NUMBER          1          </span>
<a name="l00056"></a><a class="code" href="z47__drv_8c.html#a2">00056</a> <span class="preprocessor">#define USE_IRQ            TRUE       </span>
<a name="l00057"></a><a class="code" href="z47__drv_8c.html#a3">00057</a> <span class="preprocessor">#define ADDRSPACE_COUNT    1          </span>
<a name="l00058"></a><a class="code" href="z47__drv_8c.html#a4">00058</a> <span class="preprocessor">#define ADDRSPACE_SIZE     0x18       </span>
00060 <span class="preprocessor"></span><span class="comment">/* debug defines */</span>
<a name="l00061"></a><a class="code" href="z47__drv_8c.html#a5">00061</a> <span class="preprocessor">#define DBG_MYLEVEL        llHdl-&gt;dbgLevel    </span>
<a name="l00062"></a><a class="code" href="z47__drv_8c.html#a6">00062</a> <span class="preprocessor">#define DBH                llHdl-&gt;dbgHdl      </span>
<a name="l00063"></a><a class="code" href="z47__drv_8c.html#a7">00063</a> <span class="preprocessor">#define OSH                llHdl-&gt;osHdl       </span>
00065 <span class="preprocessor"></span><span class="comment">/*-----------------------------------------+</span>
00066 <span class="comment">|  TYPEDEFS                                |</span>
00067 <span class="comment">+-----------------------------------------*/</span>
00068 
<a name="l00069"></a><a class="code" href="structLL__HANDLE.html">00069</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
00070     <span class="comment">/* general */</span>
<a name="l00071"></a><a class="code" href="structLL__HANDLE.html#o0">00071</a>     int32                   memAlloc;       
<a name="l00072"></a><a class="code" href="structLL__HANDLE.html#o1">00072</a>     OSS_HANDLE              *osHdl;         
<a name="l00073"></a><a class="code" href="structLL__HANDLE.html#o2">00073</a>     OSS_IRQ_HANDLE          *irqHdl;        
<a name="l00074"></a><a class="code" href="structLL__HANDLE.html#o3">00074</a>     DESC_HANDLE             *descHdl;       
<a name="l00075"></a><a class="code" href="structLL__HANDLE.html#o4">00075</a>     MACCESS                 ma;             
<a name="l00076"></a><a class="code" href="structLL__HANDLE.html#o5">00076</a>     MDIS_IDENT_FUNCT_TBL    idFuncTbl;      
00077     <span class="comment">/* debug */</span>
<a name="l00078"></a><a class="code" href="structLL__HANDLE.html#o6">00078</a>     u_int32                 dbgLevel;       
<a name="l00079"></a><a class="code" href="structLL__HANDLE.html#o7">00079</a>     DBG_HANDLE              *dbgHdl;        
00080     <span class="comment">/* misc */</span>
<a name="l00081"></a><a class="code" href="structLL__HANDLE.html#o8">00081</a>     OSS_SIG_HANDLE          *sigHdl;        
<a name="l00082"></a><a class="code" href="structLL__HANDLE.html#o9">00082</a>     u_int32                 irqCount;       
<a name="l00083"></a><a class="code" href="structLL__HANDLE.html#o10">00083</a>     u_int8                  wdStart;        
00084 } <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>;
00085 
00086 <span class="comment">/* include files which need LL_HANDLE */</span>
00087 <span class="preprocessor">#include &lt;MEN/ll_entry.h&gt;</span>       <span class="comment">/* low-level driver jump table */</span>
00088 <span class="preprocessor">#include &lt;MEN/z47_drv.h&gt;</span>        <span class="comment">/* Z47 driver header file      */</span>
00089 
<a name="l00090"></a><a class="code" href="z47__drv_8c.html#a8">00090</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="z47__drv_8c.html#a8">IdentString</a>[]=MENT_XSTR(MAK_REVISION);
00091 
00092 <span class="comment">/*-----------------------------------------+</span>
00093 <span class="comment">|  PROTOTYPES                              |</span>
00094 <span class="comment">+-----------------------------------------*/</span>
00095 <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a9">Z47_Init</a>(DESC_SPEC *descSpec, OSS_HANDLE *osHdl,
00096                         MACCESS *ma, OSS_SEM_HANDLE *devSemHdl,
00097                         OSS_IRQ_HANDLE *irqHdl, <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP);
00098 <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a10">Z47_Exit</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP);
00099 <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a11">Z47_Read</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 *value);
00100 <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a12">Z47_Write</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 value);
00101 <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a13">Z47_SetStat</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,int32 ch, int32 code,
00102                             INT32_OR_64 value32_or_64);
00103 <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a14">Z47_GetStat</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, int32 code,
00104                             INT32_OR_64 *value32_or64P);
00105 <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a15">Z47_BlockRead</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, <span class="keywordtype">void</span> *buf, int32 size,
00106                             int32 *nbrRdBytesP);
00107 <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a16">Z47_BlockWrite</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 ch, <span class="keywordtype">void</span> *buf, int32 size,
00108                                 int32 *nbrWrBytesP);
00109     <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a17">Z47_Irq</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl);
00110 <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a18">Z47_Info</a>(int32 infoType, ...);
00111 <span class="keyword">static</span> <span class="keywordtype">char</span>* <a class="code" href="z47__drv_8c.html#a19">Ident</a>(<span class="keywordtype">void</span>);
00112 <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a20">Cleanup</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 retCode);
00113 <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a21">WdogTrig</a>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl, int32 pat);
00114 
00115 <span class="comment">/****************************** Z47_GetEntry ********************************/</span>
00120 <span class="preprocessor">#ifdef _ONE_NAMESPACE_PER_DRIVER_</span>
00121 <span class="preprocessor"></span>    <span class="keyword">extern</span> <span class="keywordtype">void</span> LL_GetEntry(
00122         LL_ENTRY* drvP
00123     )
00124 #<span class="keywordflow">else</span>
<a name="l00125"></a><a class="code" href="z47__drv_8c.html#a22">00125</a>     <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="z47__drv_8c.html#a22">__Z47_GetEntry</a>(
00126         LL_ENTRY* drvP
00127     )
00128 #endif
00129 {
00130     drvP-&gt;init        = <a class="code" href="z47__drv_8c.html#a9">Z47_Init</a>;
00131     drvP-&gt;exit        = <a class="code" href="z47__drv_8c.html#a10">Z47_Exit</a>;
00132     drvP-&gt;read        = <a class="code" href="z47__drv_8c.html#a11">Z47_Read</a>;
00133     drvP-&gt;write       = <a class="code" href="z47__drv_8c.html#a12">Z47_Write</a>;
00134     drvP-&gt;blockRead   = <a class="code" href="z47__drv_8c.html#a15">Z47_BlockRead</a>;
00135     drvP-&gt;blockWrite  = <a class="code" href="z47__drv_8c.html#a16">Z47_BlockWrite</a>;
00136     drvP-&gt;setStat     = <a class="code" href="z47__drv_8c.html#a13">Z47_SetStat</a>;
00137     drvP-&gt;getStat     = <a class="code" href="z47__drv_8c.html#a14">Z47_GetStat</a>;
00138     drvP-&gt;irq         = <a class="code" href="z47__drv_8c.html#a17">Z47_Irq</a>;
00139     drvP-&gt;info        = <a class="code" href="z47__drv_8c.html#a18">Z47_Info</a>;
00140 }
00141 
00142 <span class="comment">/******************************** Z47_Init **********************************/</span>
<a name="l00166"></a><a class="code" href="z47__drv_8c.html#a9">00166</a> <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a9">Z47_Init</a>(
00167     DESC_SPEC       *descP,
00168     OSS_HANDLE      *osHdl,
00169     MACCESS         *ma,
00170     OSS_SEM_HANDLE  *devSemHdl,
00171     OSS_IRQ_HANDLE  *irqHdl,
00172     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>       **llHdlP
00173 )
00174 {
00175     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = NULL;
00176     u_int32 gotsize;
00177     int32 error;
00178     u_int32 value;
00179 
00180     <span class="comment">/*------------------------------+</span>
00181 <span class="comment">    |  prepare the handle           |</span>
00182 <span class="comment">    +------------------------------*/</span>
00183     *llHdlP = NULL;     <span class="comment">/* set low-level driver handle to NULL */</span>
00184 
00185     <span class="comment">/* alloc */</span>
00186     <span class="keywordflow">if</span> ((llHdl = (<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>*)OSS_MemGet(
00187                     osHdl, <span class="keyword">sizeof</span>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>), &amp;gotsize)) == NULL)
00188         <span class="keywordflow">return</span> (ERR_OSS_MEM_ALLOC);
00189 
00190     <span class="comment">/* clear */</span>
00191     OSS_MemFill(osHdl, gotsize, (<span class="keywordtype">char</span>*)llHdl, 0x00);
00192 
00193     <span class="comment">/* init */</span>
00194     llHdl-&gt;memAlloc    = gotsize;
00195     llHdl-&gt;osHdl       = osHdl;
00196     llHdl-&gt;irqHdl      = irqHdl;
00197     llHdl-&gt;ma          = *ma;
00198 
00199     <span class="comment">/*------------------------------+</span>
00200 <span class="comment">    |  init id function table       |</span>
00201 <span class="comment">    +------------------------------*/</span>
00202     <span class="comment">/* driver's ident function */</span>
00203     llHdl-&gt;idFuncTbl.idCall[0].identCall = <a class="code" href="z47__drv_8c.html#a19">Ident</a>;
00204     <span class="comment">/* library's ident functions */</span>
00205     llHdl-&gt;idFuncTbl.idCall[1].identCall = DESC_Ident;
00206     llHdl-&gt;idFuncTbl.idCall[2].identCall = OSS_Ident;
00207     <span class="comment">/* terminator */</span>
00208     llHdl-&gt;idFuncTbl.idCall[3].identCall = NULL;
00209 
00210     <span class="comment">/*------------------------------+</span>
00211 <span class="comment">    |  prepare debugging            |</span>
00212 <span class="comment">    +------------------------------*/</span>
00213     <a class="code" href="z47__drv_8c.html#a5">DBG_MYLEVEL</a> = OSS_DBG_DEFAULT;      <span class="comment">/* set OS specific debug level */</span>
00214     DBGINIT((NULL,&amp;<a class="code" href="z47__drv_8c.html#a6">DBH</a>));
00215 
00216     <span class="comment">/*------------------------------+</span>
00217 <span class="comment">    |  scan descriptor              |</span>
00218 <span class="comment">    +------------------------------*/</span>
00219     <span class="keywordflow">if</span> ((error = DESC_Init(descP, osHdl, &amp;llHdl-&gt;descHdl)))
00220         <span class="keywordflow">return</span> (<a class="code" href="z47__drv_8c.html#a20">Cleanup</a>(llHdl, error));
00221 
00222     <span class="comment">/* DEBUG_LEVEL_DESC */</span>
00223     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, OSS_DBG_DEFAULT,
00224                                 &amp;value, <span class="stringliteral">"DEBUG_LEVEL_DESC"</span>)) &amp;&amp;
00225         error != ERR_DESC_KEY_NOTFOUND)
00226         <span class="keywordflow">return</span> (<a class="code" href="z47__drv_8c.html#a20">Cleanup</a>(llHdl, error));
00227 
00228     DESC_DbgLevelSet(llHdl-&gt;descHdl, value);
00229 
00230     <span class="comment">/* DEBUG_LEVEL */</span>
00231     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, OSS_DBG_DEFAULT,
00232                                 &amp;llHdl-&gt;dbgLevel, <span class="stringliteral">"DEBUG_LEVEL"</span>)) &amp;&amp;
00233         error != ERR_DESC_KEY_NOTFOUND)
00234         <span class="keywordflow">return</span> (<a class="code" href="z47__drv_8c.html#a20">Cleanup</a>(llHdl, error));
00235 
00236     <span class="comment">/*------------------------------+</span>
00237 <span class="comment">    |  init hardware                |</span>
00238 <span class="comment">    +------------------------------*/</span>
00239     <span class="comment">/* do nothing */</span>
00240 
00241     *llHdlP = llHdl;        <span class="comment">/* set low-level driver handle */</span>
00242 
00243     <span class="keywordflow">return</span> (ERR_SUCCESS);
00244 }
00245 
00246 <span class="comment">/****************************** Z47_Exit ************************************/</span>
<a name="l00255"></a><a class="code" href="z47__drv_8c.html#a10">00255</a> <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a10">Z47_Exit</a>(
00256     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> **llHdlP
00257 )
00258 {
00259     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = *llHdlP;
00260     int32 error = 0;
00261 
00262     DBGWRT_1((<a class="code" href="z47__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z47_Exit\n"</span>));
00263 
00264     <span class="comment">/*------------------------------+</span>
00265 <span class="comment">    |  de-init hardware             |</span>
00266 <span class="comment">    +------------------------------*/</span>
00267     <span class="comment">/* disable interrupt */</span>
00268     MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, Z47_IRQT, 0);
00269 
00270     <span class="comment">/*------------------------------+</span>
00271 <span class="comment">    |  clean up memory              |</span>
00272 <span class="comment">    +------------------------------*/</span>
00273     *llHdlP = NULL;     <span class="comment">/* set low-level driver handle to NULL */</span>
00274     error = <a class="code" href="z47__drv_8c.html#a20">Cleanup</a>(llHdl, error);
00275 
00276     <span class="keywordflow">return</span> (error);
00277 }
00278 
00279 <span class="comment">/****************************** Z47_Read ************************************/</span>
<a name="l00290"></a><a class="code" href="z47__drv_8c.html#a11">00290</a> <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a11">Z47_Read</a>(
00291     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>  *llHdl,
00292     int32      ch,
00293     int32      *valueP
00294 )
00295 {
00296     DBGWRT_1((<a class="code" href="z47__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z47_Read: ch=%d\n"</span>, ch));
00297 
00298     <span class="keywordflow">return</span>(ERR_LL_ILL_FUNC);
00299 }
00300 
00301 <span class="comment">/****************************** Z47_Write ***********************************/</span>
<a name="l00312"></a><a class="code" href="z47__drv_8c.html#a12">00312</a> <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a12">Z47_Write</a>(
00313     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>  *llHdl,
00314     int32      ch,
00315     int32      value
00316 )
00317 {
00318     DBGWRT_1((<a class="code" href="z47__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z47_Write: ch=%d  val=0x%x\n"</span>, ch, value));
00319 
00320     <span class="keywordflow">return</span>(ERR_LL_ILL_FUNC);
00321 }
00322 
00323 <span class="comment">/****************************** Z47_SetStat *********************************/</span>
<a name="l00336"></a><a class="code" href="z47__drv_8c.html#a13">00336</a> <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a13">Z47_SetStat</a>(
00337     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>   *llHdl,
00338     int32       code,
00339     int32       ch,
00340     INT32_OR_64 value32_or_64
00341 )
00342 {
00343     int32 value = (int32)value32_or_64;     <span class="comment">/* 32bit value */</span>
00344     MACCESS ma = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>;
00345     int32 error = ERR_SUCCESS;
00346     DBGCMD( <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> func[] = <span class="stringliteral">"LL - Z47_SetStat"</span> );
00347 
00348     DBGWRT_1((<a class="code" href="z47__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"%s: ch=%d code=0x%04x value=0x%x\n"</span>,
00349                 func, ch, code, value));
00350 
00351     <span class="keywordflow">switch</span> (code) {
00352         <span class="comment">/*--------------------------+</span>
00353 <span class="comment">        |  debug level              |</span>
00354 <span class="comment">        +--------------------------*/</span>
00355         <span class="keywordflow">case</span> M_LL_DEBUG_LEVEL:
00356             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o6">dbgLevel</a> = value;
00357             <span class="keywordflow">break</span>;
00358         <span class="comment">/*--------------------------+</span>
00359 <span class="comment">        |  enable interrupts        |</span>
00360 <span class="comment">        +--------------------------*/</span>
00361         <span class="keywordflow">case</span> M_MK_IRQ_ENABLE:
00362             <span class="keywordflow">break</span>;
00363         <span class="comment">/*--------------------------+</span>
00364 <span class="comment">        |  set irq counter          |</span>
00365 <span class="comment">        +--------------------------*/</span>
00366         <span class="keywordflow">case</span> M_LL_IRQ_COUNT:
00367             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqCount</a> = value;
00368             <span class="keywordflow">break</span>;
00369         <span class="comment">/*--------------------------+</span>
00370 <span class="comment">        |  channel direction        |</span>
00371 <span class="comment">        +--------------------------*/</span>
00372         <span class="keywordflow">case</span> M_LL_CH_DIR:
00373             <span class="keywordflow">if</span> (value != M_CH_INOUT) {
00374                 error = ERR_LL_ILL_DIR;
00375             }
00376             <span class="keywordflow">break</span>;
00377         <span class="comment">/*--------------------------+</span>
00378 <span class="comment">        |  old WDOG codes           |</span>
00379 <span class="comment">        +--------------------------*/</span>
00380         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a1">WDOG_START</a>:
00381             MSETMASK_D32(ma, Z47_CFG, Z47_CFG_WDOG_EN);
00382             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">wdStart</a> = 1;
00383             <span class="keywordflow">break</span>;
00384 
00385         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a3">WDOG_STOP</a>:
00386             MCLRMASK_D32(ma, Z47_CFG, Z47_CFG_WDOG_EN);
00387             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">wdStart</a> = 0;
00388             <span class="keywordflow">break</span>;
00389 
00390         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a2">WDOG_TRIG</a>:
00391             error = <a class="code" href="z47__drv_8c.html#a21">WdogTrig</a>(llHdl, 0);
00392             <span class="keywordflow">break</span>;
00393 
00394         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a4">WDOG_TIME</a>:
00395             <span class="comment">/* given time [ms], IP core time [us] */</span>
00396             MWRITE_D32(ma, Z47_MAXT, value * 1000);
00397             <span class="keywordflow">break</span>;
00398 
00399         <span class="comment">/*--------------------------+</span>
00400 <span class="comment">        |  new WDOG codes           |</span>
00401 <span class="comment">        +--------------------------*/</span>
00402         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a7">WDOG_RESET_CTRL</a>:
00403             MSETMASK_D32(ma, Z47_CFG, Z47_CFG_WDOG_RESTART);
00404             <span class="keywordflow">break</span>;
00405 
00406         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a8">WDOG_TRIG_PAT</a>:
00407             error = <a class="code" href="z47__drv_8c.html#a21">WdogTrig</a>(llHdl, value);
00408             <span class="keywordflow">break</span>;
00409 
00410         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a9">WDOG_TIME_MIN</a>:
00411             <span class="comment">/* given time [us], IP core time [us] */</span>
00412             MWRITE_D32(ma, Z47_MINT, value);
00413             <span class="keywordflow">break</span>;
00414 
00415         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a10">WDOG_TIME_MAX</a>:
00416             <span class="comment">/* given time [us], IP core time [us] */</span>
00417             MWRITE_D32(ma, Z47_MAXT, value);
00418             <span class="keywordflow">break</span>;
00419 
00420         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a11">WDOG_TIME_IRQ</a>:
00421             <span class="comment">/*</span>
00422 <span class="comment">             * given time [us], IP core time [us]</span>
00423 <span class="comment">             * Note: Value&gt;0 enables the interrupt!</span>
00424 <span class="comment">             */</span>
00425             MWRITE_D32(ma, Z47_IRQT, value);
00426             <span class="keywordflow">break</span>;
00427 
00428         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a12">WDOG_OUT_PIN</a>:
00429             <span class="keywordflow">switch</span> (value){
00430             <span class="keywordflow">case</span> 0:
00431                 MCLRMASK_D32(ma, Z47_CTRL, Z47_CTRL_SET_WDOG_TOUT);
00432             <span class="keywordflow">break</span>;
00433             <span class="keywordflow">case</span> 1:
00434                 MSETMASK_D32(ma, Z47_CTRL, Z47_CTRL_SET_WDOG_TOUT);
00435                 <span class="keywordflow">break</span>;
00436             <span class="keywordflow">default</span>:
00437                 DBGWRT_ERR((<a class="code" href="z47__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"*** %s(WDOG_OUT_PIN): illegal pattern 0x%x\n"</span>,
00438                     func, value));
00439                 <span class="keywordflow">return</span> ERR_LL_ILL_PARAM;
00440             }
00441             <span class="keywordflow">break</span>;
00442 
00443         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a13">WDOG_OUT_REASON</a>:
00444             MCLRMASK_D32(ma, Z47_STAT, Z47_STAT_REASON_TOUT_MASK);
00445             <span class="keywordflow">break</span>;
00446 
00447         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a14">WDOG_IRQ_PIN</a>:
00448             <span class="keywordflow">switch</span> (value) {
00449             <span class="keywordflow">case</span> 0:
00450                 MCLRMASK_D32(ma, Z47_CTRL, Z47_CTRL_SET_WDOG_IRQ);
00451                 <span class="keywordflow">break</span>;
00452             <span class="keywordflow">case</span> 1:
00453                 MSETMASK_D32(ma, Z47_CTRL, Z47_CTRL_SET_WDOG_IRQ);
00454                 <span class="keywordflow">break</span>;
00455             <span class="keywordflow">default</span>:
00456                 DBGWRT_ERR((<a class="code" href="z47__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"*** %s(WDOG_IRQ_PIN): illegal pattern 0x%x\n"</span>,
00457                     func, value));
00458                 <span class="keywordflow">return</span> ERR_LL_ILL_PARAM;
00459             }
00460             <span class="keywordflow">break</span>;
00461 
00462         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a15">WDOG_IRQ_SIGSET</a>:
00463             <span class="comment">/* signal already installed ? */</span>
00464             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">sigHdl</a>) {
00465                 error = ERR_OSS_SIG_SET;
00466                 <span class="keywordflow">break</span>;
00467             }
00468             error = OSS_SigCreate(<a class="code" href="z47__drv_8c.html#a7">OSH</a>, value, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">sigHdl</a>);
00469             <span class="keywordflow">break</span>;
00470 
00471         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a16">WDOG_IRQ_SIGCLR</a>:
00472             <span class="comment">/* signal not installed ? */</span>
00473             <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">sigHdl</a> == NULL) {
00474                 error = ERR_OSS_SIG_CLR;
00475                 <span class="keywordflow">break</span>;
00476             }
00477             error = OSS_SigRemove(<a class="code" href="z47__drv_8c.html#a7">OSH</a>, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">sigHdl</a>);
00478             <span class="keywordflow">break</span>;
00479 
00480         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a17">WDOG_IRQ_REASON</a>:
00481             MCLRMASK_D32(ma, Z47_STAT, Z47_STAT_REASON_IRQ_MASK);
00482             <span class="keywordflow">break</span>;
00483 
00484         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a18">WDOG_ERR_PIN</a>:
00485             <span class="keywordflow">switch</span> (value) {
00486             <span class="keywordflow">case</span> 0:
00487                 MCLRMASK_D32(ma, Z47_CTRL, Z47_CTRL_SW_ERR);
00488                 <span class="keywordflow">break</span>;
00489             <span class="keywordflow">case</span> 1:
00490                 MSETMASK_D32(ma, Z47_CTRL, Z47_CTRL_SW_ERR);
00491                 <span class="keywordflow">break</span>;
00492             <span class="keywordflow">default</span>:
00493                 DBGWRT_ERR((<a class="code" href="z47__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"*** %s(WDOG_ERR_PIN): illegal pattern 0x%x\n"</span>,
00494                     func, value));
00495                 <span class="keywordflow">return</span> ERR_LL_ILL_PARAM;
00496             }
00497             <span class="keywordflow">break</span>;
00498                     
00499         <span class="comment">/*--------------------------+</span>
00500 <span class="comment">        |  (unknown)                |</span>
00501 <span class="comment">        +--------------------------*/</span>
00502         <span class="keywordflow">default</span>:
00503             error = ERR_LL_UNK_CODE;
00504     }
00505 
00506     <span class="keywordflow">return</span> (error);
00507 }
00508 
00509 <span class="comment">/****************************** Z47_GetStat *********************************/</span>
<a name="l00525"></a><a class="code" href="z47__drv_8c.html#a14">00525</a> <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a14">Z47_GetStat</a>(
00526     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>   *llHdl,
00527     int32       code,
00528     int32       ch,
00529     INT32_OR_64 *value32_or_64P
00530 )
00531 {
00532     int32 *valueP = (int32*)value32_or_64P;     <span class="comment">/* pointer to 32bit value */</span>
00533     INT32_OR_64 *value64P = value32_or_64P;     <span class="comment">/* stores 32/64bit pointer */</span>
00534     MACCESS ma = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>;
00535     int32 error = ERR_SUCCESS;
00536     int32 read;
00537 
00538     DBGWRT_1((<a class="code" href="z47__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z47_GetStat: ch=%d code=0x%04x\n"</span>, ch, code));
00539 
00540     <span class="keywordflow">switch</span> (code) {
00541         <span class="comment">/*--------------------------+</span>
00542 <span class="comment">        |  debug level              |</span>
00543 <span class="comment">        +--------------------------*/</span>
00544         <span class="keywordflow">case</span> M_LL_DEBUG_LEVEL:
00545             *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o6">dbgLevel</a>;
00546             <span class="keywordflow">break</span>;
00547         <span class="comment">/*--------------------------+</span>
00548 <span class="comment">        |  number of channels       |</span>
00549 <span class="comment">        +--------------------------*/</span>
00550         <span class="keywordflow">case</span> M_LL_CH_NUMBER:
00551             *valueP = <a class="code" href="z47__drv_8c.html#a1">CH_NUMBER</a>;
00552             <span class="keywordflow">break</span>;
00553         <span class="comment">/*--------------------------+</span>
00554 <span class="comment">        |  channel direction        |</span>
00555 <span class="comment">        +--------------------------*/</span>
00556         <span class="keywordflow">case</span> M_LL_CH_DIR:
00557             *valueP = M_CH_INOUT;
00558             <span class="keywordflow">break</span>;
00559         <span class="comment">/*--------------------------+</span>
00560 <span class="comment">        |  channel length [bits]    |</span>
00561 <span class="comment">        +--------------------------*/</span>
00562         <span class="keywordflow">case</span> M_LL_CH_LEN:
00563             *valueP = 1;
00564             <span class="keywordflow">break</span>;
00565         <span class="comment">/*--------------------------+</span>
00566 <span class="comment">        |  channel type info        |</span>
00567 <span class="comment">        +--------------------------*/</span>
00568         <span class="keywordflow">case</span> M_LL_CH_TYP:
00569             *valueP = M_CH_BINARY;
00570             <span class="keywordflow">break</span>;
00571         <span class="comment">/*--------------------------+</span>
00572 <span class="comment">        |  irq counter              |</span>
00573 <span class="comment">        +--------------------------*/</span>
00574         <span class="keywordflow">case</span> M_LL_IRQ_COUNT:
00575             *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqCount</a>;
00576             <span class="keywordflow">break</span>;
00577         <span class="comment">/*--------------------------+</span>
00578 <span class="comment">        |  ID PROM check enabled    |</span>
00579 <span class="comment">        +--------------------------*/</span>
00580         <span class="keywordflow">case</span> M_LL_ID_CHECK:
00581             *valueP = 0;
00582             <span class="keywordflow">break</span>;
00583         <span class="comment">/*--------------------------+</span>
00584 <span class="comment">        |  ident table pointer      |</span>
00585 <span class="comment">        |  (treat as non-block!)    |</span>
00586 <span class="comment">        +--------------------------*/</span>
00587         <span class="keywordflow">case</span> M_MK_BLK_REV_ID:
00588             *value64P = (INT32_OR_64)&amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o5">idFuncTbl</a>;
00589             <span class="keywordflow">break</span>;
00590 
00591         <span class="comment">/*--------------------------+</span>
00592 <span class="comment">        |  old WDOG codes           |</span>
00593 <span class="comment">        +--------------------------*/</span>
00594         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a4">WDOG_TIME</a>:
00595             <span class="comment">/* IP core time [us], requested time [ms] */</span>
00596             *valueP = (MREAD_D32(ma, Z47_MAXT)) / 1000;
00597             <span class="keywordflow">break</span>;
00598 
00599         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a5">WDOG_STATUS</a>:
00600             read = MREAD_D32(ma, Z47_STAT);
00601             *valueP = (read &amp; Z47_STAT_WDOG_CNT_STATUS) ? 1 : 0;
00602             <span class="keywordflow">break</span>;
00603 
00604         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a6">WDOG_SHOT</a>:
00605             read = MREAD_D32(ma, Z47_STAT);
00606             read = (read &amp; Z47_STAT_REASON_TOUT_MASK) &gt;&gt; Z47_STAT_REASON_TOUT_SHIFT;
00607             *valueP = ((read == Z47_REASON_MIN_TOUT) ||
00608                        (read == Z47_REASON_MAX_TOUT) ) ? 1 : 0;
00609             <span class="keywordflow">break</span>;
00610 
00611         <span class="comment">/*--------------------------+</span>
00612 <span class="comment">        |  new WDOG codes           |</span>
00613 <span class="comment">        +--------------------------*/</span>
00614         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a8">WDOG_TRIG_PAT</a>:
00615             *valueP = MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, Z47_CLR);
00616             <span class="keywordflow">break</span>;
00617 
00618         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a9">WDOG_TIME_MIN</a>:
00619             <span class="comment">/* IP core time [us], requested time [us] */</span>
00620             *valueP = MREAD_D32(ma, Z47_MINT);
00621             <span class="keywordflow">break</span>;
00622 
00623         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a10">WDOG_TIME_MAX</a>:
00624             <span class="comment">/* IP core time [us], requested time [us] */</span>
00625             *valueP = MREAD_D32(ma, Z47_MAXT);
00626             <span class="keywordflow">break</span>;
00627 
00628         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a11">WDOG_TIME_IRQ</a>:
00629             <span class="comment">/* IP core time [us], requested time [us] */</span>
00630             *valueP = MREAD_D32(ma, Z47_IRQT);
00631             <span class="keywordflow">break</span>;
00632 
00633         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a12">WDOG_OUT_PIN</a>:
00634             read = MREAD_D32(ma, Z47_CTRL);
00635             *valueP = (read &amp; Z47_CTRL_SET_WDOG_TOUT) ? 1 : 0;
00636             <span class="keywordflow">break</span>;
00637 
00638         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a13">WDOG_OUT_REASON</a>:
00639             read = MREAD_D32(ma, Z47_STAT);
00640             *valueP = (read &amp; Z47_STAT_REASON_TOUT_MASK) &gt;&gt; Z47_STAT_REASON_TOUT_SHIFT;
00641             <span class="keywordflow">break</span>;
00642 
00643         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a14">WDOG_IRQ_PIN</a>:
00644             read = MREAD_D32(ma, Z47_CTRL);
00645             *valueP = (read &amp; Z47_CTRL_SET_WDOG_IRQ) ? 1 : 0;
00646             <span class="keywordflow">break</span>;
00647 
00648         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a17">WDOG_IRQ_REASON</a>:
00649             read = MREAD_D32(ma, Z47_STAT);
00650             *valueP = (read &amp; Z47_STAT_REASON_IRQ_MASK) &gt;&gt; Z47_STAT_REASON_IRQ_SHIFT;
00651             <span class="keywordflow">break</span>;
00652 
00653         <span class="keywordflow">case</span> <a class="code" href="wdog_8h.html#a18">WDOG_ERR_PIN</a>:
00654             read = MREAD_D32(ma, Z47_CTRL);
00655             *valueP = (read &amp; Z47_CTRL_SW_ERR) ? 1 : 0;
00656             <span class="keywordflow">break</span>;
00657             
00658         <span class="comment">/*--------------------------+</span>
00659 <span class="comment">        |  (unknown)                |</span>
00660 <span class="comment">        +--------------------------*/</span>
00661         <span class="keywordflow">default</span>:
00662             error = ERR_LL_UNK_CODE;
00663     }
00664 
00665     <span class="keywordflow">return</span> (error);
00666 }
00667 
00668 <span class="comment">/******************************* Z47_BlockRead ******************************/</span>
<a name="l00681"></a><a class="code" href="z47__drv_8c.html#a15">00681</a> <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a15">Z47_BlockRead</a>(
00682     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00683     int32     ch,
00684     <span class="keywordtype">void</span>      *buf,
00685     int32     size,
00686     int32     *nbrRdBytesP
00687 )
00688 {
00689     DBGWRT_1((<a class="code" href="z47__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z47_BlockRead: ch=%d, size=%d\n"</span>, ch, size));
00690 
00691     <span class="comment">/* return number of read bytes */</span>
00692     *nbrRdBytesP = 0;
00693 
00694     <span class="keywordflow">return</span> (ERR_LL_ILL_FUNC);
00695 }
00696 
00697 <span class="comment">/****************************** Z47_BlockWrite *****************************/</span>
<a name="l00710"></a><a class="code" href="z47__drv_8c.html#a16">00710</a> <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a16">Z47_BlockWrite</a>(
00711     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00712     int32     ch,
00713     <span class="keywordtype">void</span>      *buf,
00714     int32     size,
00715     int32     *nbrWrBytesP
00716 )
00717 {
00718     DBGWRT_1((<a class="code" href="z47__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"LL - Z47_BlockWrite: ch=%d, size=%d\n"</span>, ch, size));
00719 
00720     <span class="comment">/* return number of written bytes */</span>
00721     *nbrWrBytesP = 0;
00722 
00723     <span class="keywordflow">return</span> (ERR_LL_ILL_FUNC);
00724 }
00725 
00726 <span class="comment">/****************************** Z47_Irq ************************************/</span>
<a name="l00744"></a><a class="code" href="z47__drv_8c.html#a17">00744</a> <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a17">Z47_Irq</a>(
00745     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl
00746 )
00747 {
00748     <span class="keywordflow">if</span> (MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, Z47_STAT) &amp; Z47_STAT_WDOG_IRQ_STATUS){
00749 
00750         IDBGWRT_1((<a class="code" href="z47__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; LL - Z47_Irq\n"</span>));
00751 
00752         <span class="comment">/* clear interrupt */</span>
00753         MSETMASK_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, Z47_STAT, Z47_STAT_WDOG_IRQ_STATUS);
00754         
00755         <span class="comment">/* if requested send signal to application */</span>
00756         <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">sigHdl</a>)
00757             OSS_SigSend(<a class="code" href="z47__drv_8c.html#a7">OSH</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">sigHdl</a>);
00758         
00759         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqCount</a>++;
00760 
00761         <span class="keywordflow">return</span> (LL_IRQ_DEVICE);
00762     }
00763 
00764     <span class="keywordflow">return</span> (LL_IRQ_DEV_NOT);
00765 }
00766 
00767 <span class="comment">/****************************** Z47_Info ***********************************/</span>
<a name="l00805"></a><a class="code" href="z47__drv_8c.html#a18">00805</a> <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a18">Z47_Info</a>(
00806     int32 infoType,
00807     ...
00808 )
00809 {
00810     int32   error = ERR_SUCCESS;
00811     va_list argptr;
00812 
00813     va_start(argptr, infoType);
00814 
00815     <span class="keywordflow">switch</span> (infoType) {
00816         <span class="comment">/*-------------------------------+</span>
00817 <span class="comment">        |  hardware characteristics      |</span>
00818 <span class="comment">        |  (all addr/data modes ORed)    |</span>
00819 <span class="comment">        +-------------------------------*/</span>
00820         <span class="keywordflow">case</span> LL_INFO_HW_CHARACTER:
00821         {
00822             u_int32 *addrModeP = va_arg(argptr, u_int32*);
00823             u_int32 *dataModeP = va_arg(argptr, u_int32*);
00824         
00825             *addrModeP = MDIS_MA08;
00826             *dataModeP = MDIS_MD08 | MDIS_MD16;
00827             <span class="keywordflow">break</span>;
00828         }
00829         <span class="comment">/*-------------------------------+</span>
00830 <span class="comment">        |  nr of required address spaces |</span>
00831 <span class="comment">        |  (total spaces used)           |</span>
00832 <span class="comment">        +-------------------------------*/</span>
00833         <span class="keywordflow">case</span> LL_INFO_ADDRSPACE_COUNT:
00834         {
00835             u_int32 *nbrOfAddrSpaceP = va_arg(argptr, u_int32*);
00836         
00837             *nbrOfAddrSpaceP = <a class="code" href="z47__drv_8c.html#a3">ADDRSPACE_COUNT</a>;
00838             <span class="keywordflow">break</span>;
00839         }
00840         <span class="comment">/*-------------------------------+</span>
00841 <span class="comment">        |  address space type            |</span>
00842 <span class="comment">        |  (widest used data mode)       |</span>
00843 <span class="comment">        +-------------------------------*/</span>
00844         <span class="keywordflow">case</span> LL_INFO_ADDRSPACE:
00845         {
00846             u_int32 addrSpaceIndex = va_arg(argptr, u_int32);
00847             u_int32 *addrModeP = va_arg(argptr, u_int32*);
00848             u_int32 *dataModeP = va_arg(argptr, u_int32*);
00849             u_int32 *addrSizeP = va_arg(argptr, u_int32*);
00850         
00851             <span class="keywordflow">if</span> (addrSpaceIndex &gt;= <a class="code" href="z47__drv_8c.html#a3">ADDRSPACE_COUNT</a>)
00852                 error = ERR_LL_ILL_PARAM;
00853             <span class="keywordflow">else</span> {
00854                 *addrModeP = MDIS_MA08;
00855                 *dataModeP = MDIS_MD16;
00856                 *addrSizeP = <a class="code" href="z47__drv_8c.html#a4">ADDRSPACE_SIZE</a>;
00857             }
00858 
00859             <span class="keywordflow">break</span>;
00860         }
00861         <span class="comment">/*-------------------------------+</span>
00862 <span class="comment">        |  interrupt required            |</span>
00863 <span class="comment">        +-------------------------------*/</span>
00864         <span class="keywordflow">case</span> LL_INFO_IRQ:
00865         {
00866             u_int32 *useIrqP = va_arg(argptr, u_int32*);
00867 
00868             *useIrqP = <a class="code" href="z47__drv_8c.html#a2">USE_IRQ</a>;
00869             <span class="keywordflow">break</span>;
00870         }
00871         <span class="comment">/*-------------------------------+</span>
00872 <span class="comment">        |  process lock mode             |</span>
00873 <span class="comment">        +-------------------------------*/</span>
00874         <span class="keywordflow">case</span> LL_INFO_LOCKMODE:
00875         {
00876             u_int32 *lockModeP = va_arg(argptr, u_int32*);
00877 
00878             *lockModeP = LL_LOCK_CALL;
00879             <span class="keywordflow">break</span>;
00880         }
00881         <span class="comment">/*-------------------------------+</span>
00882 <span class="comment">        |  (unknown)                     |</span>
00883 <span class="comment">        +-------------------------------*/</span>
00884         <span class="keywordflow">default</span>:
00885             error = ERR_LL_ILL_PARAM;
00886     }
00887 
00888     va_end(argptr);
00889 
00890     <span class="keywordflow">return</span> (error);
00891 }
00892 
00893 <span class="comment">/******************************** Ident ************************************/</span>
<a name="l00898"></a><a class="code" href="z47__drv_8c.html#a19">00898</a> <span class="keyword">static</span> <span class="keywordtype">char</span>* <a class="code" href="z47__drv_8c.html#a19">Ident</a>(<span class="keywordtype">void</span>)
00899 {
00900     <span class="keywordflow">return</span>( (<span class="keywordtype">char</span>*) <a class="code" href="z47__drv_8c.html#a8">IdentString</a> );
00901 }
00902 
00903 <span class="comment">/********************************* Cleanup *********************************/</span>
<a name="l00913"></a><a class="code" href="z47__drv_8c.html#a20">00913</a> <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a20">Cleanup</a>(
00914     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00915     int32     retCode
00916 )
00917 {
00918     <span class="comment">/*------------------------------+</span>
00919 <span class="comment">    |  close handles                |</span>
00920 <span class="comment">    +------------------------------*/</span>
00921     <span class="comment">/* clean up desc */</span>
00922     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o3">descHdl</a>)
00923         DESC_Exit(&amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o3">descHdl</a>);
00924 
00925     <span class="comment">/* clean up debug */</span>
00926     DBGEXIT((&amp;<a class="code" href="z47__drv_8c.html#a6">DBH</a>));
00927 
00928     <span class="comment">/*------------------------------+</span>
00929 <span class="comment">    |  free memory                  |</span>
00930 <span class="comment">    +------------------------------*/</span>
00931     <span class="comment">/* free my handle */</span>
00932     OSS_MemFree(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, (int8*)llHdl, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o0">memAlloc</a>);
00933 
00934     <span class="comment">/*return error code */</span>
00935     <span class="keywordflow">return</span> (retCode);
00936 }
00937 
00938 <span class="comment">/********************************* WdogTrig *********************************/</span>
<a name="l00948"></a><a class="code" href="z47__drv_8c.html#a21">00948</a> <span class="keyword">static</span> int32 <a class="code" href="z47__drv_8c.html#a21">WdogTrig</a>(
00949     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00950     int32     pat
00951 )
00952 {
00953     int32 error=ERR_SUCCESS;
00954     int32 read, val;
00955 
00956     <span class="comment">/* watchdog not enabled ? */</span>
00957     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">wdStart</a> == 0) {
00958         <span class="keywordflow">return</span> ERR_LL_DEV_NOTRDY;
00959     }
00960 
00961     <span class="comment">/* read last written pattern */</span>
00962     read = MREAD_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, Z47_CLR);
00963 
00964     <span class="comment">/* pattern from user */</span>
00965     <span class="keywordflow">if</span> (pat) {
00966         <span class="comment">/* illegal pattern? */</span>
00967         <span class="keywordflow">if</span> ((pat != <a class="code" href="wdog_8h.html#a19">WDOG_TRIGPAT</a>(0)) &amp;&amp;
00968             (pat != <a class="code" href="wdog_8h.html#a19">WDOG_TRIGPAT</a>(1))) {
00969             DBGWRT_ERR((<a class="code" href="z47__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"*** LL - Z17_SetStat(WDOG_TRIG_PAT): illegal pattern 0x%x\n"</span>, pat));
00970             <span class="keywordflow">return</span> ERR_LL_ILL_PARAM;
00971         }
00972 
00973         <span class="comment">/* not the first trigger? */</span>
00974         <span class="keywordflow">if</span> (read != 0) {
00975             <span class="comment">/* repeated pattern? */</span>
00976             <span class="keywordflow">if</span> (pat == read) {
00977                 DBGWRT_ERR((<a class="code" href="z47__drv_8c.html#a6">DBH</a>, <span class="stringliteral">"*** LL - Z17_SetStat(WDOG_TRIG_PAT): repeated pattern 0x%x\n"</span>, pat));
00978                 <span class="keywordflow">return</span> ERR_LL_ILL_PARAM;
00979             }
00980         }
00981         val = pat;
00982     }
00983     <span class="comment">/* no pattern given */</span>
00984     <span class="keywordflow">else</span> {
00985         <span class="comment">/* first trigger? */</span>
00986         <span class="keywordflow">if</span> (read == 0)
00987             read = <a class="code" href="wdog_8h.html#a19">WDOG_TRIGPAT</a>(0);
00988 
00989         <span class="comment">/* compute new pattern from read pattern */</span>
00990         val =  (read &amp; 0x0f) &lt;&lt; 4;
00991         val |= (read &amp; 0xf0) &gt;&gt; 4;
00992     }
00993 
00994     <span class="comment">/* write trigger pattern */</span>
00995     MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, Z47_CLR, val);
00996 
00997     <span class="keywordflow">return</span> (error);
00998 }
</pre></div>
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for Z47 MDIS Driver using <a href="http://www.doxygen.org">doxygen</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

